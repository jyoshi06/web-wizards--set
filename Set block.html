<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DSU Trichy – SET Building (Interactive 3D)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; height:100%; background:#0b0e13; overflow:hidden; }
    #ui {
      position: fixed; top: 12px; left: 12px; z-index: 10; 
      font-family: system-ui, sans-serif; color: #fff; user-select: none;
      background: rgba(20,20,28,.6); padding: 10px 12px; border-radius: 10px; backdrop-filter: blur(4px);
      box-shadow: 0 6px 20px rgba(0,0,0,.35);
    }
    #ui h1 { font-size: 14px; margin: 0 0 8px; font-weight: 700; letter-spacing:.2px; }
    #ui .row { display:flex; gap:8px; align-items:center; margin:6px 0; }
    #ui button, #ui label {
      background:#1a2233; color:#fff; border:1px solid #2b3a55; border-radius:8px; padding:8px 10px; cursor:pointer;
      font-size:12px;
    }
    #ui button:hover { background:#283654; }
    #credits {
      position: fixed; right: 12px; bottom: 10px; color:#a9b4c9; font: 12px/1.4 system-ui, sans-serif; opacity:.8;
    }
    canvas { display:block; }
    
    /* Voice & Translation Modal Styles */
    #voiceModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      background: rgba(20,20,28,.95);
      padding: 20px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      box-shadow: 0 6px 30px rgba(0,0,0,.5);
      width: 80%;
      max-width: 500px;
      color: white;
      font-family: system-ui, sans-serif;
    }
    #voiceModal .modal-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #voiceModal h2 {
      margin: 0;
      font-size: 18px;
      color: #fff;
    }
    #voiceModal img {
      max-width: 100%;
      border-radius: 8px;
    }
    #voiceModal .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }
    #voiceModal select, #voiceModal button {
      background: #1a2233;
      color: #fff;
      border: 1px solid #2b3a55;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    #voiceModal button:hover {
      background: #283654;
    }
    #closeModal {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    #content {
      display: none; /* Hide the content as it's only for voice */
    }
  </style>

  <!-- three.js + helpers -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.155.0/build/three.module.js",
        "three/addons/controls/OrbitControls.js": "https://unpkg.com/three@0.155.0/examples/jsm/controls/OrbitControls.js",
        "three/addons/objects/Sky.js": "https://unpkg.com/three@0.155.0/examples/jsm/objects/Sky.js"
      }
    }
  </script>
</head>
<body>
<div id="ui">
  <h1>DSU SET – Interactive 3D</h1>
  <div class="row">
    <button id="toggleDayNight">Toggle Day / Night</button>
    <button id="toggleAutoRotate">Toggle Building Rotate</button>
    <button id="resetCam">Reset Camera</button>
  </div>
  <div class="row">
    <label>
      <input type="checkbox" id="labVisibleChk" />
      Show/Hide Lab (debug)
    </label>
  </div>
  <div class="row">
    <button id="voiceBtn">Voice & Translation</button>
  </div>
  <div class="row" style="max-width:240px;color:#a9b4c9">
    Tip: Click the <b>6th floor</b> to open the Lab. Scroll to zoom, right-drag to pan.
  </div>
</div>
<div id="credits">Day/Night lighting, video screen, floor picking, and lab spawn implemented in Three.js.</div>

<!-- Voice & Translation Modal -->
<div id="voiceModal">
  <button id="closeModal">&times;</button>
  <div class="modal-content">
    <h2>About Our College</h2>
    <img src="college.jpg" alt="College Photo" id="collegePhoto">
    <div id="content">
      Dayananda Sagar University, SET Building, is a state-of-the-art facility for engineering and technology. 
      It houses modern classrooms, laboratories, and research centers to foster innovation and learning.
    </div>
    <div class="controls">
      <select id="language">
        <option value="en">English</option>
        <option value="te">Telugu</option>
        <option value="ta">Tamil</option>
      </select>
      <button onclick="speakText()">Speak</button>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { Sky } from 'three/addons/objects/Sky.js';

let renderer, scene, camera, controls, clock;
let buildingGroup, floors = [], autoRotate=false, labGroup, labVisible=false;
let dayMode = true, hemiLight, sunLight, nightAmbient, nightPointLights=[];
let sky, sunUniforms;
let video, videoTex, videoMesh;

init();
animate();

function init() {
  // Renderer
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.0;
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  document.body.appendChild(renderer.domElement);

  // Scene
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x90c4ff);

  // Camera
  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
  camera.position.set(30, 28, 60);

  // Controls
  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.enablePan = true;
  controls.minDistance = 10;
  controls.maxDistance = 250;
  controls.target.set(0, 15, 0);
  controls.update();

  clock = new THREE.Clock();

  // Ground & landscaping strip
  const groundMat = new THREE.MeshStandardMaterial({ color: 0x9cb089, roughness: 1, metalness: 0 });
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(600, 400), groundMat);
  ground.rotation.x = -Math.PI/2;
  ground.receiveShadow = true;
  scene.add(ground);

  // Pathway (asphalt)
  const path = new THREE.Mesh(new THREE.RingGeometry(60, 80, 64), new THREE.MeshStandardMaterial({ color: 0x2a2f37, roughness:.95 }));
  path.rotation.x = -Math.PI/2;
  path.position.set(-10, 0.01, -5);
  scene.add(path);

  // Sky (for realistic day)
  sky = new Sky();
  sky.scale.setScalar(450000);
  scene.add(sky);
  sunUniforms = sky.material.uniforms;
  sunUniforms.turbidity.value = 8;
  sunUniforms.rayleigh.value = 1.2;
  sunUniforms.mieCoefficient.value = 0.005;
  sunUniforms.mieDirectionalG.value = 0.8;

  // Lights (Day)
  hemiLight = new THREE.HemisphereLight(0xb9d1ff, 0x3f3f3f, 0.5);
  scene.add(hemiLight);

  sunLight = new THREE.DirectionalLight(0xffffff, 2.2);
  sunLight.position.set(80,120,50);
  sunLight.castShadow = true;
  sunLight.shadow.mapSize.set(2048,2048);
  sunLight.shadow.camera.left = -120;
  sunLight.shadow.camera.right = 120;
  sunLight.shadow.camera.top = 120;
  sunLight.shadow.camera.bottom = -120;
  scene.add(sunLight);

  setSunPosition(15, 0.35); // elevation, azimuth (day)

  // Night extras (start hidden)
  nightAmbient = new THREE.AmbientLight(0x1a1c2a, 0.6);
  nightAmbient.visible = false;
  scene.add(nightAmbient);

  // --------- BUILDING (11 floors, realistic white facade) ----------
  buildingGroup = new THREE.Group();
  scene.add(buildingGroup);

  const floorCount = 11;
  const floorHeight = 3.6; // meters per floor
  const baseW = 48, baseD = 16; // footprint approximate
  const cornerChamfer = 0.6;

  // Core facade material (white plaster)
  const facade = new THREE.MeshPhysicalMaterial({
    color: 0xf2f3f5,
    roughness: 0.82,
    metalness: 0.0,
    clearcoat: 0.04
  });

  // Dark window material (slightly reflective)
  const windowMat = new THREE.MeshPhysicalMaterial({
    color: 0x1a2028,
    roughness: 0.15,
    metalness: 0.0,
    transmission: 0.0,
    reflectivity: 0.4
  });

  // Pillared entrance canopy (from refs)
  const canopy = new THREE.Group();
  const canopyTop = new THREE.Mesh(new THREE.BoxGeometry(14, 1.2, 8), new THREE.MeshStandardMaterial({ color: 0xdddfe4, roughness:.6 }));
  canopyTop.position.set(-baseW*0.25, floorHeight*1.6, baseD*0.52);
  canopyTop.castShadow = canopyTop.receiveShadow = true;
  canopy.add(canopyTop);

  const pillarGeo = new THREE.BoxGeometry(1.2, floorHeight*1.6, 1.2);
  for (let i=0;i<4;i++){
    const p = new THREE.Mesh(pillarGeo, new THREE.MeshStandardMaterial({ color: 0xe6e8ec, roughness:.7 }));
    p.castShadow = p.receiveShadow = true;
    p.position.set(
      -baseW*0.25 + (i%2===0? -5.2: 5.2),
      (floorHeight*1.6)/2,
      baseD*0.52 + (i<2?-3:3)
    );
    canopy.add(p);
  }
  buildingGroup.add(canopy);

  // Building body
  const body = new THREE.Group();
  buildingGroup.add(body);

  // Make each floor a separate mesh for picking
  for (let i=0;i<floorCount;i++){
    const y = (i*floorHeight) + floorHeight/2;
    const floorMesh = new THREE.Mesh(beveledBox(baseW, floorHeight, baseD, cornerChamfer), facade);
    floorMesh.position.y = y;
    floorMesh.castShadow = true; floorMesh.receiveShadow = true;
    floorMesh.userData.floorNumber = i+1;
    body.add(floorMesh);
    floors.push(floorMesh);
  }

  // Simple roof parapet
  const parapet = new THREE.Mesh(new THREE.BoxGeometry(baseW+0.6, 0.7, baseD+0.6), new THREE.MeshStandardMaterial({ color: 0xf0f2f6, roughness:.85 }));
  parapet.position.y = floorCount*floorHeight + 0.35;
  parapet.castShadow = parapet.receiveShadow = true;
  body.add(parapet);

  // Repeating window strips (instanced for performance)
  addWindowBands(body, baseW, baseD, floorCount, floorHeight, windowMat);

  // Position building and rotate slightly to match references perspective
  buildingGroup.position.set(0,0,0);
  buildingGroup.rotation.y = Math.PI * -0.08;

  // Small trees/greenery rows
  plantShrubsLine(new THREE.Vector3(-baseW*0.6,0, baseD*0.75), new THREE.Vector3(baseW*0.9,0, baseD*0.75), 18);
  plantShrubsLine(new THREE.Vector3(-baseW*0.6,0,-baseD), new THREE.Vector3(baseW*0.9,0,-baseD), 12);

  // --------- LAB (hidden initially) ----------
  labGroup = createLab();
  labGroup.position.set(baseW*0.9 + 15, 0, 0); // beside the set
  labGroup.visible = false;
  scene.add(labGroup);

  // Video setup (screen in lab)
  video = document.createElement('video');
  video.src = 'lab.mp4'; // <-- put your file beside this HTML (or replace with a path)
  video.loop = true;
  video.muted = true; // autoplay policy
  video.playsInline = true;

  videoTex = new THREE.VideoTexture(video);
  videoTex.colorSpace = THREE.SRGBColorSpace;
  videoTex.minFilter = THREE.LinearFilter;
  videoTex.magFilter = THREE.LinearFilter;

  videoMesh = labGroup.getObjectByName('VideoScreen');
  if (videoMesh) {
    videoMesh.material = new THREE.MeshBasicMaterial({ map: videoTex, toneMapped: false });
  }

  // Night lamps inside lab
  for (let i=0;i<4;i++){
    const p = new THREE.PointLight(0xfff2d0, 0.8, 25, 2);
    p.position.set(labGroup.position.x + (i<2?-6:6), 6.5, (i%2===0?-4:4));
    p.visible = false;
    scene.add(p);
    nightPointLights.push(p);
  }

  // Interactions
  window.addEventListener('resize', onResize);
  renderer.domElement.addEventListener('pointerdown', onPointerDown);

  // UI hooks
  document.getElementById('toggleDayNight').onclick = toggleDayNight;
  document.getElementById('toggleAutoRotate').onclick = ()=> autoRotate = !autoRotate;
  document.getElementById('resetCam').onclick = resetCamera;
  const labChk = document.getElementById('labVisibleChk');
  labChk.onchange = e => setLabVisible(e.target.checked);
  
  // Voice & Translation UI
  document.getElementById('voiceBtn').onclick = () => {
    document.getElementById('voiceModal').style.display = 'block';
  };
  document.getElementById('closeModal').onclick = () => {
    document.getElementById('voiceModal').style.display = 'none';
  };
}

function beveledBox(w,h,d, bevel=0.4){
  // Simple beveled edges via box + small chamfer using EdgesGeometry normal smoothing trick
  const g = new THREE.BoxGeometry(w,h,d, 1,1,1);
  return g;
}

function addWindowBands(parent, W, D, floors, H, mat){
  const instanced = new THREE.InstancedMesh(new THREE.BoxGeometry(1.4, 1.6, 0.12), mat, floors*20);
  let idx = 0;
  const dummy = new THREE.Object3D();

  for (let f=0; f<floors; f++){
    const y = f*H + H*0.6;
    // long rows on front and back
    for (let i=0;i<8;i++){
      const x = -W/2 + 4 + i*(W-8)/7;
      dummy.position.set(x, y, D/2 + 0.06);
      dummy.rotation.set(0, 0, 0);
      dummy.updateMatrix();
      instanced.setMatrixAt(idx++, dummy.matrix);

      dummy.position.set(x, y, -D/2 - 0.06);
      dummy.updateMatrix();
      instanced.setMatrixAt(idx++, dummy.matrix);
    }
    // short rows on sides
    for (let i=0;i<2;i++){
      const z = -D/2 + 3 + i*(D-6);
      dummy.position.set(W/2 + 0.06, y, z);
      dummy.rotation.set(0, Math.PI/2, 0);
      dummy.updateMatrix();
      instanced.setMatrixAt(idx++, dummy.matrix);

      dummy.position.set(-W/2 - 0.06, y, z);
      dummy.updateMatrix();
      instanced.setMatrixAt(idx++, dummy.matrix);
    }
  }
  instanced.castShadow = true;
  parent.add(instanced);
}

function plantShrubsLine(a,b,count){
  const dir = new THREE.Vector3().subVectors(b,a).divideScalar(count-1);
  for (let i=0;i<count;i++){
    const p = new THREE.Vector3().copy(a).addScaledVector(dir,i);
    const shrub = makeShrub();
    shrub.position.copy(p);
    scene.add(shrub);
  }
}
function makeShrub(){
  const g1 = new THREE.SphereGeometry(1.1, 16, 12);
  const m1 = new THREE.MeshStandardMaterial({ color: 0x3f6944, roughness:.9 });
  const s1 = new THREE.Mesh(g1, m1); s1.castShadow = s1.receiveShadow = true;
  const g2 = new THREE.CylinderGeometry(0.1,0.35,0.8,8);
  const m2 = new THREE.MeshStandardMaterial({ color: 0x6a4a2b, roughness:1 });
  const t = new THREE.Mesh(g2,m2); t.position.y = 0.4;
  const g = new THREE.Group(); s1.position.y=1.1; g.add(s1,t); return g;
}

function createLab(){
  const g = new THREE.Group();

  // Room shell
  const room = new THREE.Mesh(new THREE.BoxGeometry(20, 6, 14), new THREE.MeshStandardMaterial({
    color: 0xf3f4f6, roughness:.9, metalness:0
  }));
  room.position.y = 3;
  room.receiveShadow = true; room.castShadow = false;

  // Hollow the room (flip-normals inner box)
  const inner = new THREE.Mesh(new THREE.BoxGeometry(19.6, 5.6, 13.6), new THREE.MeshStandardMaterial({
    color: 0xf5f7fb, roughness:.85, side: THREE.BackSide
  }));
  inner.position.copy(room.position);
  inner.receiveShadow = true; inner.castShadow = false;

  g.add(room, inner);

  // Desks rows
  const deskMat = new THREE.MeshStandardMaterial({ color: 0xe3e7ec, roughness:.8 });
  const legMat = new THREE.MeshStandardMaterial({ color: 0xbec7d3, roughness:.9 });
  const monitorMat = new THREE.MeshPhysicalMaterial({ color: 0x0d0f14, roughness:.25, clearcoat:.04 });

  for (let row=0; row<2; row++){
    for (let i=0;i<6;i++){
      const desk = new THREE.Mesh(new THREE.BoxGeometry(2.2,0.12,0.8), deskMat);
      desk.position.set(-7 + i*2.6, 1, -2.2 + row*4.4);
      desk.castShadow = desk.receiveShadow = true;
      g.add(desk);

      const leg1 = new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.9,10), legMat);
      const leg2 = leg1.clone(), leg3 = leg1.clone(), leg4 = leg1.clone();
      leg1.position.set(desk.position.x-1, 0.5, desk.position.z-0.35);
      leg2.position.set(desk.position.x+1, 0.5, desk.position.z-0.35);
      leg3.position.set(desk.position.x-1, 0.5, desk.position.z+0.35);
      leg4.position.set(desk.position.x+1, 0.5, desk.position.z+0.35);
      [leg1,leg2,leg3,leg4].forEach(m=>{m.castShadow=true; m.receiveShadow=true; g.add(m);});

      const monitor = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.8, 1.3), monitorMat);
      monitor.position.set(desk.position.x, 1.6, desk.position.z);
      monitor.castShadow = true; g.add(monitor);
    }
  }

  // Ceiling cove lights (emissive strips – night)
  const coveMat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffd58a, emissiveIntensity: 0.0 });
  const cove = new THREE.Mesh(new THREE.BoxGeometry(18, 0.2, 0.2), coveMat);
  cove.position.set(0, 5.6, 0);
  g.add(cove);

  // Video screen
  const vid = new THREE.Mesh(new THREE.PlaneGeometry(5.5, 3.1), new THREE.MeshBasicMaterial({ color: 0x000000 }));
  vid.rotation.y = Math.PI; // face inward
  vid.position.set(0, 3.1, 6.7);
  vid.name = 'VideoScreen';
  g.add(vid);

  // Floor
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(20,14), new THREE.MeshStandardMaterial({ color: 0xd8dde6, roughness:.95 }));
  floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; g.add(floor);

  return g;
}

function setSunPosition(elevationDeg=15, azimuth=0.25){
  const phi = THREE.MathUtils.degToRad(90 - elevationDeg);
  const theta = 2 * Math.PI * (azimuth - 0.5);
  const sun = new THREE.Vector3().setFromSphericalCoords(1, phi, theta);
  sunLight.position.copy(sun).multiplyScalar(120);
  sunUniforms.sunPosition.value.copy(sun).multiplyScalar(450000);
}

function toggleDayNight(){
  dayMode = !dayMode;
  if (dayMode){
    scene.background = new THREE.Color(0x90c4ff);
    hemiLight.visible = true; sunLight.visible = true;
    nightAmbient.visible = false;
    nightPointLights.forEach(p=>p.visible=false);
    setSunPosition(15, 0.35);
    renderer.toneMappingExposure = 1.0;
  } else {
    scene.background = new THREE.Color(0x061018);
    hemiLight.visible = false; sunLight.visible = false;
    nightAmbient.visible = true;
    nightPointLights.forEach(p=>p.visible=true);
    renderer.toneMappingExposure = 1.25;
  }
}

function setLabVisible(v){
  labVisible = v;
  labGroup.visible = v;
  document.getElementById('labVisibleChk').checked = v;
}

function resetCamera(){
  camera.position.set(30, 28, 60);
  controls.target.set(0, 15, 0);
  controls.update();
}

function onResize(){
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

function onPointerDown(event){
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((event.clientX - rect.left)/rect.width)*2 - 1;
  mouse.y = -((event.clientY - rect.top)/rect.height)*2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(floors, false);
  if (intersects.length > 0){
    const fno = intersects[0].object.userData.floorNumber;
    // 6th-floor behavior
    if (fno === 6){
      setLabVisible(true);
      autoRotate = true;
      // autoplay video when lab opens
      video.play().catch(()=>{/* ignore autoplay block if any */});
    }
  }
}

// ----- Animation loop -----
function animate(){
  requestAnimationFrame(animate);
  const dt = clock.getDelta();

  if (autoRotate){
    buildingGroup.rotation.y += dt * 0.35; // slow spin
  }

  controls.update();
  renderer.render(scene, camera);
}
</script>

<!-- Voice & Translation Script (from code 2) -->
<script>
async function translateText(text, targetLang) {
  if (targetLang === "en") return text; // No translation needed

  // Free Google Translate API (via unofficial endpoint)
  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${targetLang}&dt=t&q=${encodeURI(text)}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    return data[0].map(item => item[0]).join(""); // Extract translated text
  } catch (error) {
    console.error("Translation error:", error);
    return text;
  }
}

async function speakText() {
  const content = document.getElementById("content").innerText;
  const lang = document.getElementById("language").value;

  // Translate first if not English
  const finalText = await translateText(content, lang);

  // Speak
  const speech = new SpeechSynthesisUtterance(finalText);
  speech.lang = (lang === "te") ? "te-IN" : (lang === "ta") ? "ta-IN" : "en-US";
  speech.rate = 1; // speed
  window.speechSynthesis.speak(speech);
}
</script>

</body>
</html>